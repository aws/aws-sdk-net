using Amazon.DynamoDBv2;
using Amazon.DynamoDBv2.DataModel;
using Amazon.DynamoDBv2.Model;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;
using System;
using System.Linq;
using System.Linq.Expressions;
using Amazon.DynamoDBv2.DocumentModel;
using Amazon.Util;
using DynamoDBContextConfig = Amazon.DynamoDBv2.DataModel.DynamoDBContextConfig;

namespace AWSSDK_DotNet.UnitTests
{
    [TestClass]
    public class ContextInternalTests
    {
        public class TestEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }
            [DynamoDBRangeKey]
            public string Name { get; set; }
            public string Description { get; set; }
            public string Counter { get; set; }
            public int? NullableValue { get; set; }

            [DynamoDBAutoGeneratedTimestamp]
            public DateTime? UpdatedAt { get; set; }

        }

        public class TestEntityWithUpdateBehavior
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBProperty("Prop1")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string Prop1 { get; set; }
        }

        [DynamoDBTable("TestEntityWithUpdateBehavior")]
        public class TestEntityWithFlattenedUpdateBehavior
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public NestedEntity Nested { get; set; }
        }

        public class NestedEntity
        {
            [DynamoDBProperty("Prop1")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string FlatProp1 { get; set; }
        }

        [DynamoDBTable("TestEntityWithDeepFlatten")]
        public class DeepFlattenEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public Level1 Level1 { get; set; }
        }

        public class Level1
        {
            [DynamoDBProperty("PropA")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropA { get; set; }

            [DynamoDBFlatten]
            public Level2 Level2 { get; set; }
        }

        public class Level2
        {
            [DynamoDBProperty("PropB")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropB { get; set; }

            [DynamoDBFlatten]
            public Level3 Level3 { get; set; }
        }

        public class Level3
        {
            [DynamoDBProperty("PropC")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropC { get; set; }
        }

        [DynamoDBTable("TestEntityWithDeepFlattenPartial")]
        public class DeepFlattenEntityPartial
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public Level1Partial Level1 { get; set; }
        }

        public class Level1Partial
        {
            [DynamoDBProperty("PropA")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropA { get; set; }

            [DynamoDBFlatten]
            public Level2Partial Level2 { get; set; }
        }

        public class Level2Partial
        {
            public string RegularProp { get; set; }
        }

        [DynamoDBTable("TestEntityWithSiblingFlatten")]
        public class SiblingFlattenEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public SiblingA A { get; set; }

            [DynamoDBFlatten]
            public SiblingB B { get; set; }
        }

        public class SiblingA
        {
            [DynamoDBProperty("PropX")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropX { get; set; }
        }

        public class SiblingB
        {
            [DynamoDBProperty("PropY")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropY { get; set; }
        }

        private Mock<IAmazonDynamoDB> mockClient;
        private DynamoDBContext context;

        [TestInitialize]
        public void TestInitialize()
        {
            mockClient = new Mock<IAmazonDynamoDB>(MockBehavior.Strict);
            mockClient.Setup(m => m.Config).Returns(new AmazonDynamoDBConfig());
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntity")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntity",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement
                            {
                                AttributeName = "Id",
                                KeyType = KeyType.HASH
                            },
                            new KeySchemaElement
                            {
                                AttributeName = "Name",
                                KeyType = KeyType.RANGE
                            }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition
                            {
                                AttributeName = "Id",
                                AttributeType = ScalarAttributeType.N
                            },
                            new AttributeDefinition
                            {
                                AttributeName = "Name",
                                AttributeType = ScalarAttributeType.S
                            }
                        }
                    }
                });
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement
                            {
                                AttributeName = "Id",
                                KeyType = KeyType.HASH
                            }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition
                            {
                                AttributeName = "Id",
                                AttributeType = ScalarAttributeType.N
                            }
                        }
                    }
                });

            context = new DynamoDBContext(mockClient.Object, new DynamoDBContextConfig());
        }


        [TestMethod]
        public void ConvertScan_WithFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 = :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);

            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual(1, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertScan_WithNameFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Name == "foo";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 = :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Name", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual("foo", actualFilterExpression.ExpressionAttributeValues[":C0"].AsString());
        }

        [TestMethod]
        public void ConvertScan_WithGreaterThanFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Id > 10;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 > :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual(10, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertScan_WithAndFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Id == 1 && e.Name == "foo";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("(#C0 = :C0) AND (#C1 = :C1)", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.AreEqual("Name", actualFilterExpression.ExpressionAttributeNames["#C1"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
            Assert.AreEqual("foo", actualFilterExpression.ExpressionAttributeValues[":C1"].AsString());
        }

        [TestMethod]
        public void ConvertQueryByValue_WithHashKeyOnly()
        {
            var result = context.ConvertQueryByValue<TestEntity>(1, null, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var actualResult = result.Search;
            Assert.IsNotNull(actualResult.Filter);
            Assert.AreEqual(1, actualResult.Filter.ToConditions().Count);
            Assert.IsNull(actualResult.FilterExpression);
            Assert.IsNotNull(actualResult.AttributesToGet);
            Assert.AreEqual(6, actualResult.AttributesToGet.Count);
        }

        [TestMethod]
        public void ConvertQueryByValue_WithHashKeyAndExpressionFilter()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Name == "bar";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr
            };

            var result = context.ConvertQueryByValue<TestEntity>(1, null, operationConfig);

            Assert.IsNotNull(result);

            var search = (dynamic)result;
            Assert.IsNotNull(search.Search);
            Assert.IsNotNull(search.Search.KeyExpression);
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionStatement.Contains("#hashKey = :hashKey"));
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey"));
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey"));
            var keyValue = search.Search.KeyExpression.ExpressionAttributeValues[":hashKey"];
            Assert.AreEqual(1, keyValue.AsInt());

            Assert.IsNotNull(search.Search.FilterExpression);
            Assert.AreEqual("#C0 = :C0", search.Search.FilterExpression.ExpressionStatement);
            Assert.AreEqual("Name", search.Search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.AreEqual("bar", search.Search.FilterExpression.ExpressionAttributeValues[":C0"].ToString());
        }
        [TestMethod]
        public void ObjectToItemStorageHelper_SerializesAllProperties()
        {
            var entity = new TestEntity
            {
                Id = 42,
                Name = "TestName",
                Description = "TestDescription",
                NullableValue = 99
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.AreEqual(42, storage.Document["Id"].AsInt());
            Assert.AreEqual("TestName", storage.Document["Name"].AsString());
            Assert.AreEqual("TestDescription", storage.Document["Description"].AsString());
            Assert.AreEqual(99, storage.Document["NullableValue"].AsInt());
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_KeysOnly_SerializesOnlyKeys()
        {
            var entity = new TestEntity
            {
                Id = 7,
                Name = "KeyName",
                Description = "ShouldNotBeSerialized",
                NullableValue = 123
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: true, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.AreEqual(7, storage.Document["Id"].AsInt());
            Assert.AreEqual("KeyName", storage.Document["Name"].AsString());
            Assert.IsFalse(storage.Document.ContainsKey("Description"));
            Assert.IsFalse(storage.Document.ContainsKey("NullableValue"));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_IgnoreNullValues_DoesNotSerializeNulls()
        {
            var entity = new TestEntity
            {
                Id = 1,
                Name = "NullTest",
                Description = null,
                NullableValue = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: true);

            Assert.IsNotNull(storage);
            Assert.AreEqual(1, storage.Document["Id"].AsInt());
            Assert.AreEqual("NullTest", storage.Document["Name"].AsString());
            Assert.IsFalse(storage.Document.ContainsKey("Description"));
            Assert.IsFalse(storage.Document.ContainsKey("NullableValue"));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_NullObject_ThrowsArgumentNullException()
        {
            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);

            Assert.ThrowsException<ArgumentNullException>(() =>
                context.ObjectToItemStorageHelper(null, config, flatConfig, keysOnly: false, ignoreNullValues: false)
            );
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_NullValue_SetsTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 100,
                Name = "TimestampTest",
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.IsTrue(storage.Document.ContainsKey("UpdatedAt"));
            var timestampValue = storage.Document["UpdatedAt"].AsString();
            Assert.IsNotNull(timestampValue);
            Assert.IsTrue(DateTime.TryParse(timestampValue, null, System.Globalization.DateTimeStyles.RoundtripKind, out var parsed));
            Assert.IsTrue((DateTime.UtcNow - parsed.ToUniversalTime()).TotalSeconds < 10);
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_NonNullValue_DoesNotOverwrite()
        {
            var now = DateTime.UtcNow.AddDays(-1);
            var entity = new TestEntity
            {
                Id = 101,
                Name = "TimestampTest",
                UpdatedAt = now
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.IsTrue(storage.Document.ContainsKey("UpdatedAt"));
            var timestampValue = storage.Document["UpdatedAt"].AsDateTime();
            Assert.AreEqual(now.ToUniversalTime().ToString(AWSSDKUtils.ISO8601DateFormat), timestampValue.ToUniversalTime().ToString(AWSSDKUtils.ISO8601DateFormat));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_IgnoreNullValues_StillSetsTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 102,
                Name = "TimestampTest",
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: true);

            Assert.IsNotNull(storage);
            Assert.IsTrue(storage.Document.ContainsKey("UpdatedAt"));
            var timestampValue = storage.Document["UpdatedAt"].AsString();
            Assert.IsNotNull(timestampValue);
            Assert.IsTrue(DateTime.TryParse(timestampValue, null, System.Globalization.DateTimeStyles.RoundtripKind, out _));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_NotMarkedProperty_NullValue_DoesNotSetTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 103,
                Name = null,
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: true);

            Assert.IsNotNull(storage);
            Assert.IsFalse(storage.Document.ContainsKey("Name"));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_KeysOnly_DoesNotSetTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 104,
                Name = "KeysOnlyTest",
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: true, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.IsTrue(storage.Document.ContainsKey("Id"));
            Assert.IsTrue(storage.Document.ContainsKey("Name"));
            Assert.IsFalse(storage.Document.ContainsKey("UpdatedAt"));
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithNoIfNotExistsProperties_ReturnsEmptyList()
        {
            var itemStorage = new ItemStorage(new
                ItemStorageConfig(typeof(TestEntity)))
            {
            };
            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(0, result.Count);
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithIfNotExistsProperties_ReturnsAttributeNames()
        {
            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntityWithUpdateBehavior>(flatConfig);
            var itemStorage = new ItemStorage(config)
            {
                Document = new Document()
            };
            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(1, result.Count);
            Assert.AreEqual("Prop1", result.FirstOrDefault());
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithFlattenedIfNotExistsProperties_ReturnsAllAttributeNames()
        {
            // Fix: use flattened entity config instead of TestEntityWithUpdateBehavior
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntityWithFlattenedUpdateBehavior>(flatConfig);
            var itemStorage = new ItemStorage(config)
            {
                Document = new Document()
            };
            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(1, result.Count);
            Assert.IsTrue(result.Contains("Prop1"));
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithDeepFlattenedHierarchy_ReturnsAllNestedAttributeNames()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithDeepFlatten")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithDeepFlatten",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<DeepFlattenEntity>(flatConfig);
            var itemStorage = new ItemStorage(config) { Document = new Document() };

            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(3, result.Count);
            Assert.IsTrue(result.Contains("PropA"));
            Assert.IsTrue(result.Contains("PropB"));
            Assert.IsTrue(result.Contains("PropC"));
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithDeepFlattenedHierarchyPartial_ReturnsOnlyMatchingAttributes()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithDeepFlattenPartial")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithDeepFlattenPartial",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<DeepFlattenEntityPartial>(flatConfig);
            var itemStorage = new ItemStorage(config) { Document = new Document() };

            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(1, result.Count);
            Assert.IsTrue(result.Contains("PropA"));
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithSiblingFlattenedProperties_ReturnsDistinctAttributeNames()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithSiblingFlatten")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithSiblingFlatten",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<SiblingFlattenEntity>(flatConfig);
            var itemStorage = new ItemStorage(config) { Document = new Document() };

            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(2, result.Count);
            Assert.IsTrue(result.Contains("PropX"));
            Assert.IsTrue(result.Contains("PropY"));
        }
        [TestMethod]
        public void BuildCounterConditionExpression_NoCounters_ReturnsNull()
        {
            var itemStorage = new ItemStorage(new ItemStorageConfig(typeof(TestEntity)));
            // Ensure no property marked as counter
            foreach (var p in itemStorage.Config.BaseTypeStorageConfig.Properties)
                p.IsCounter = false;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNull(result);
        }

        [TestMethod]
        public void BuildCounterConditionExpression_MultipleCounters_ReturnsExpressionWithAllCounters()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var itemStorage = new ItemStorage(config);

            var props = itemStorage.Config.BaseTypeStorageConfig.Properties;

            var first = props.First(p => p.PropertyName == nameof(TestEntity.Id));
            var second = props.First(p => p.PropertyName == nameof(TestEntity.NullableValue));

            first.IsCounter = true;
            first.CounterStartValue = 5;
            first.CounterDelta = 2;

            second.IsCounter = true;
            second.CounterStartValue = 100;
            second.CounterDelta = 10;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNotNull(result);
            Assert.IsFalse(string.IsNullOrEmpty(result.ExpressionStatement));
            // Expression should contain both attribute names
            Assert.IsTrue(result.ExpressionStatement.Contains(first.AttributeName));
            Assert.IsTrue(result.ExpressionStatement.Contains(second.AttributeName));
            // Delta keys
            var firstDeltaKey = ":" + first.AttributeName + "Delta";
            var firstStartKey = ":" + first.AttributeName + "Start";
            var secondDeltaKey = ":" + second.AttributeName + "Delta";
            var secondStartKey = ":" + second.AttributeName + "Start";

            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(firstDeltaKey));
            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(firstStartKey));
            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(secondDeltaKey));
            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(secondStartKey));

            Assert.AreEqual(first.CounterDelta, result.ExpressionAttributeValues[firstDeltaKey].AsInt());
            Assert.AreEqual(first.CounterStartValue - first.CounterDelta, result.ExpressionAttributeValues[firstStartKey].AsInt());
            Assert.AreEqual(second.CounterDelta, result.ExpressionAttributeValues[secondDeltaKey].AsInt());
            Assert.AreEqual(second.CounterStartValue - second.CounterDelta, result.ExpressionAttributeValues[secondStartKey].AsInt());
        }

        [TestMethod]
        public void BuildCounterConditionExpression_FlattenedSingleCounter_ReturnsExpression()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntityWithFlattenedUpdateBehavior>(flatConfig);
            var itemStorage = new ItemStorage(config);

            // Locate flattened parent property
            var flattenParent = itemStorage.Config.BaseTypeStorageConfig.Properties.First(p => p.ShouldFlattenChildProperties);
            var child = flattenParent.FlattenProperties.First(fp => fp.AttributeName == "Prop1");
            child.IsCounter = true;
            child.CounterStartValue = 10;
            child.CounterDelta = 3;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNotNull(result);
            Assert.IsTrue(result.ExpressionStatement.Contains("Prop1"));
            var deltaKey = ":Prop1Delta";
            var startKey = ":Prop1Start";
            Assert.AreEqual(child.CounterDelta, result.ExpressionAttributeValues[deltaKey].AsInt());
            Assert.AreEqual(child.CounterStartValue - child.CounterDelta, result.ExpressionAttributeValues[startKey].AsInt());
        }

        [TestMethod]
        public void BuildCounterConditionExpression_FlattenedSiblingCounters_ReturnsExpressionForAll()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithSiblingFlatten")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithSiblingFlatten",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<SiblingFlattenEntity>(flatConfig);
            var itemStorage = new ItemStorage(config);

            var flattenParents = itemStorage.Config.BaseTypeStorageConfig.Properties.Where(p => p.ShouldFlattenChildProperties).ToList();
            Assert.AreEqual(2, flattenParents.Count, "Expected two flattened parent properties (A and B).");

            var propX = flattenParents.SelectMany(p => p.FlattenProperties).First(fp => fp.AttributeName == "PropX");
            var propY = flattenParents.SelectMany(p => p.FlattenProperties).First(fp => fp.AttributeName == "PropY");

            propX.IsCounter = true;
            propX.CounterStartValue = 50;
            propX.CounterDelta = 5;

            propY.IsCounter = true;
            propY.CounterStartValue = 200;
            propY.CounterDelta = 20;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNotNull(result);
            Assert.IsTrue(result.ExpressionStatement.Contains("PropX"));
            Assert.IsTrue(result.ExpressionStatement.Contains("PropY"));

            Assert.AreEqual(propX.CounterDelta, result.ExpressionAttributeValues[":PropXDelta"].AsInt());
            Assert.AreEqual(propX.CounterStartValue - propX.CounterDelta, result.ExpressionAttributeValues[":PropXStart"].AsInt());
            Assert.AreEqual(propY.CounterDelta, result.ExpressionAttributeValues[":PropYDelta"].AsInt());
            Assert.AreEqual(propY.CounterStartValue - propY.CounterDelta, result.ExpressionAttributeValues[":PropYStart"].AsInt());
        }
    }
}