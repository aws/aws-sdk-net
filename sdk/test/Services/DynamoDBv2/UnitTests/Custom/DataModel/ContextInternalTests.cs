using Amazon.DynamoDBv2;
using Amazon.DynamoDBv2.DataModel;
using Amazon.DynamoDBv2.Model;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;
using System;
using System.Linq.Expressions;
using Amazon.Util;
using DynamoDBContextConfig = Amazon.DynamoDBv2.DataModel.DynamoDBContextConfig;

namespace AWSSDK_DotNet.UnitTests
{
    [TestClass]
    public class ContextInternalTests
    {
        public class TestEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }
            [DynamoDBRangeKey]
            public string Name { get; set; }
            public string Description { get; set; }
            public int? NullableValue { get; set; }

            [DynamoDBAutoGeneratedTimestamp]
            public DateTime? UpdatedAt { get; set; }
        }

        private Mock<IAmazonDynamoDB> mockClient;
        private DynamoDBContext context;

        [TestInitialize]
        public void TestInitialize()
        {
            mockClient = new Mock<IAmazonDynamoDB>(MockBehavior.Strict);
            mockClient.Setup(m => m.Config).Returns(new AmazonDynamoDBConfig());
            mockClient.Setup(m => m.DescribeTable(It.IsAny<DescribeTableRequest>()))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntity",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement
                            {
                                AttributeName = "Id",
                                KeyType = KeyType.HASH
                            },
                            new KeySchemaElement
                            {
                                AttributeName = "Name",
                                KeyType = KeyType.RANGE
                            }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition
                            {
                                AttributeName = "Id",
                                AttributeType = ScalarAttributeType.N
                            },
                            new AttributeDefinition
                            {
                                AttributeName = "Name",
                                AttributeType = ScalarAttributeType.S
                            }
                        }
                    }
                });

            context = new DynamoDBContext(mockClient.Object, new DynamoDBContextConfig());
        }


        [TestMethod]
        public void ConvertScan_WithFilterExpression_ReturnsMappedFilterExpression()
        {
            // Create a filter expression (e => e.Id == 1)
            Expression<Func<TestEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 = :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);

            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual(1, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertScan_WithNameFilterExpression_ReturnsMappedFilterExpression()
        {
            // Filter: e => e.Name == "foo"
            Expression<Func<TestEntity, bool>> expr = e => e.Name == "foo";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 = :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Name", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual("foo", actualFilterExpression.ExpressionAttributeValues[":C0"].AsString());
        }

        [TestMethod]
        public void ConvertScan_WithGreaterThanFilterExpression_ReturnsMappedFilterExpression()
        {
            // Filter: e => e.Id > 10
            Expression<Func<TestEntity, bool>> expr = e => e.Id > 10;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 > :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual(10, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertScan_WithAndFilterExpression_ReturnsMappedFilterExpression()
        {
            // Filter: e => e.Id == 1 && e.Name == "foo"
            Expression<Func<TestEntity, bool>> expr = e => e.Id == 1 && e.Name == "foo";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("(#C0 = :C0) AND (#C1 = :C1)", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.AreEqual("Name", actualFilterExpression.ExpressionAttributeNames["#C1"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
            Assert.AreEqual("foo", actualFilterExpression.ExpressionAttributeValues[":C1"].AsString());
        }

        [TestMethod]
        public void ConvertQueryByValue_WithHashKeyOnly()
        {
            // Act
            var result = context.ConvertQueryByValue<TestEntity>(1, null, null);

            // Assert
            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var actualResult = result.Search;
            Assert.IsNotNull(actualResult.Filter);
            Assert.AreEqual(1,actualResult.Filter.ToConditions().Count);
            Assert.IsNull(actualResult.FilterExpression);
            Assert.IsNotNull(actualResult.AttributesToGet);
            Assert.AreEqual(typeof(TestEntity).GetProperties().Length,actualResult.AttributesToGet.Count);
        }

        [TestMethod]
        public void ConvertQueryByValue_WithHashKeyAndExpressionFilter()
        {
            // Arrange
            Expression<Func<TestEntity, bool>> expr = e => e.Name == "bar";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr
            };

            // Act
            var result = context.ConvertQueryByValue<TestEntity>(1, null, operationConfig);

            // Assert
            Assert.IsNotNull(result);

            var search = (dynamic)result;
            Assert.IsNotNull(search.Search);
            Assert.IsNotNull(search.Search.KeyExpression);
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionStatement.Contains("#hashKey = :hashKey"));
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey"));
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey"));
            var keyValue = search.Search.KeyExpression.ExpressionAttributeValues[":hashKey"];
            Assert.AreEqual(1, keyValue.AsInt());

            // Assert filter expression
            Assert.IsNotNull(search.Search.FilterExpression);
            Assert.AreEqual("#C0 = :C0", search.Search.FilterExpression.ExpressionStatement);
            Assert.AreEqual("Name", search.Search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.AreEqual("bar", search.Search.FilterExpression.ExpressionAttributeValues[":C0"].ToString());
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_SerializesAllProperties()
        {
            var entity = new TestEntity
            {
                Id = 42,
                Name = "TestName",
                Description = "TestDescription",
                NullableValue = 99
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.AreEqual(42, storage.Document["Id"].AsInt());
            Assert.AreEqual("TestName", storage.Document["Name"].AsString());
            Assert.AreEqual("TestDescription", storage.Document["Description"].AsString());
            Assert.AreEqual(99, storage.Document["NullableValue"].AsInt());
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_KeysOnly_SerializesOnlyKeys()
        {
            var entity = new TestEntity
            {
                Id = 7,
                Name = "KeyName",
                Description = "ShouldNotBeSerialized",
                NullableValue = 123
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: true, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.AreEqual(7, storage.Document["Id"].AsInt());
            Assert.AreEqual("KeyName", storage.Document["Name"].AsString());
            Assert.IsFalse(storage.Document.ContainsKey("Description"));
            Assert.IsFalse(storage.Document.ContainsKey("NullableValue"));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_IgnoreNullValues_DoesNotSerializeNulls()
        {
            var entity = new TestEntity
            {
                Id = 1,
                Name = "NullTest",
                Description = null,
                NullableValue = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: true);

            Assert.IsNotNull(storage);
            Assert.AreEqual(1, storage.Document["Id"].AsInt());
            Assert.AreEqual("NullTest", storage.Document["Name"].AsString());
            Assert.IsFalse(storage.Document.ContainsKey("Description"));
            Assert.IsFalse(storage.Document.ContainsKey("NullableValue"));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_NullObject_ThrowsArgumentNullException()
        {
            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);

            Assert.ThrowsException<ArgumentNullException>(() =>
                context.ObjectToItemStorageHelper(null, config, flatConfig, keysOnly: false, ignoreNullValues: false)
            );
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_NullValue_SetsTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 100,
                Name = "TimestampTest",
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.IsTrue(storage.Document.ContainsKey("UpdatedAt"));
            var timestampValue = storage.Document["UpdatedAt"].AsString();
            Assert.IsNotNull(timestampValue);
            Assert.IsTrue(DateTime.TryParse(timestampValue, null, System.Globalization.DateTimeStyles.RoundtripKind, out var parsed));
            Assert.IsTrue((DateTime.UtcNow - parsed.ToUniversalTime()).TotalSeconds < 10);
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_NonNullValue_DoesNotOverwrite()
        {
            var now = DateTime.UtcNow.AddDays(-1);
            var entity = new TestEntity
            {
                Id = 101,
                Name = "TimestampTest",
                UpdatedAt = now
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            Assert.IsTrue(storage.Document.ContainsKey("UpdatedAt"));
            var timestampValue = storage.Document["UpdatedAt"].AsDateTime();
            Assert.AreEqual(now.ToUniversalTime().ToString(AWSSDKUtils.ISO8601DateFormat), timestampValue.ToUniversalTime().ToString(AWSSDKUtils.ISO8601DateFormat));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_IgnoreNullValues_StillSetsTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 102,
                Name = "TimestampTest",
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: true);

            Assert.IsNotNull(storage);
            Assert.IsTrue(storage.Document.ContainsKey("UpdatedAt"));
            var timestampValue = storage.Document["UpdatedAt"].AsString();
            Assert.IsNotNull(timestampValue);
            Assert.IsTrue(DateTime.TryParse(timestampValue, null, System.Globalization.DateTimeStyles.RoundtripKind, out _));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_NotMarkedProperty_NullValue_DoesNotSetTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 103,
                Name = null, // Not marked as auto-generated timestamp
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: false, ignoreNullValues: true);

            Assert.IsNotNull(storage);
            Assert.IsFalse(storage.Document.ContainsKey("Name"));
        }

        [TestMethod]
        public void ObjectToItemStorageHelper_AutoGeneratedTimestamp_KeysOnly_DoesNotSetTimestamp()
        {
            var entity = new TestEntity
            {
                Id = 104,
                Name = "KeysOnlyTest",
                UpdatedAt = null
            };

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var storage = context.ObjectToItemStorageHelper(entity, config, flatConfig, keysOnly: true, ignoreNullValues: false);

            Assert.IsNotNull(storage);
            // Only keys should be present
            Assert.IsTrue(storage.Document.ContainsKey("Id"));
            Assert.IsTrue(storage.Document.ContainsKey("Name"));
            Assert.IsFalse(storage.Document.ContainsKey("UpdatedAt"));
        }
    }
}