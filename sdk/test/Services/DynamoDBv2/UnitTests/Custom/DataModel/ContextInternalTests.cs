using Amazon.DynamoDBv2;
using Amazon.DynamoDBv2.DataModel;
using Amazon.DynamoDBv2.Model;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;
using System;
using System.Linq;
using System.Linq.Expressions;
using Amazon.DynamoDBv2.DocumentModel;
using Amazon.Util;
using DynamoDBContextConfig = Amazon.DynamoDBv2.DataModel.DynamoDBContextConfig;
using System.Collections.Generic;

namespace AWSSDK_DotNet.UnitTests
{
    [TestClass]
    public class ContextInternalTests
    {
        public class TestEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }
            [DynamoDBRangeKey]
            public string Name { get; set; }
            public string Description { get; set; }
            public string Counter { get; set; }
            public int? NullableValue { get; set; }

            [DynamoDBAutoGeneratedTimestamp]
            public DateTime? UpdatedAt { get; set; }

        }

        public class TestEntityWithUpdateBehavior
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBProperty("Prop1")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string Prop1 { get; set; }
        }

        [DynamoDBTable("TestEntityWithUpdateBehavior")]
        public class TestEntityWithFlattenedUpdateBehavior
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public NestedEntity Nested { get; set; }
        }

        public class NestedEntity
        {
            [DynamoDBProperty("Prop1")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string FlatProp1 { get; set; }
        }

        [DynamoDBTable("TestEntityWithDeepFlatten")]
        public class DeepFlattenEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public Level1 Level1 { get; set; }
        }

        public class Level1
        {
            [DynamoDBProperty("PropA")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropA { get; set; }

            [DynamoDBFlatten]
            public Level2 Level2 { get; set; }
        }

        public class Level2
        {
            [DynamoDBProperty("PropB")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropB { get; set; }

            [DynamoDBFlatten]
            public Level3 Level3 { get; set; }
        }

        public class Level3
        {
            [DynamoDBProperty("PropC")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropC { get; set; }
        }

        [DynamoDBTable("TestEntityWithDeepFlattenPartial")]
        public class DeepFlattenEntityPartial
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public Level1Partial Level1 { get; set; }
        }

        public class Level1Partial
        {
            [DynamoDBProperty("PropA")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropA { get; set; }

            [DynamoDBFlatten]
            public Level2Partial Level2 { get; set; }
        }

        public class Level2Partial
        {
            public string RegularProp { get; set; }
        }

        [DynamoDBTable("TestEntityWithSiblingFlatten")]
        public class SiblingFlattenEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBFlatten]
            public SiblingA A { get; set; }

            [DynamoDBFlatten]
            public SiblingB B { get; set; }
        }

        public class SiblingA
        {
            [DynamoDBProperty("PropX")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropX { get; set; }
        }

        public class SiblingB
        {
            [DynamoDBProperty("PropY")]
            [DynamoDbUpdateBehavior(UpdateBehavior.IfNotExists)]
            public string PropY { get; set; }
        }

        public class TestGSIEntity
        {
            [DynamoDBHashKey]
            public int Id { get; set; }

            [DynamoDBGlobalSecondaryIndexHashKey("GSI1", Order = 1)]
            public string GsiHash { get; set; }

            [DynamoDBGlobalSecondaryIndexHashKey("GSI1", Order = 2)]
            public string GsiHash2 { get; set; }

            [DynamoDBGlobalSecondaryIndexRangeKey("GSI1", Order = 1)]
            public string GsiRange { get; set; }

            [DynamoDBGlobalSecondaryIndexRangeKey("GSI1", Order = 2)]
            public string GsiRange2 { get; set; }
        }

        private Mock<IAmazonDynamoDB> mockClient;
        private DynamoDBContext context;

        [TestInitialize]
        public void TestInitialize()
        {
            mockClient = new Mock<IAmazonDynamoDB>(MockBehavior.Strict);
            mockClient.Setup(m => m.Config).Returns(new AmazonDynamoDBConfig());
            mockClient.Setup(m => m.DescribeTable(It.IsAny<DescribeTableRequest>()))
                .Returns((DescribeTableRequest req) =>
                {
                    if (req.TableName == "TestGSIEntity")
                    {
                        return new DescribeTableResponse
                        {
                            Table = new TableDescription
                            {
                                TableName = "TestGSIEntity",
                                KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                                {
                                    new KeySchemaElement
                                    {
                                        AttributeName = "Id",
                                        KeyType = KeyType.HASH
                                    }
                                },
                                AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                                {
                                    new AttributeDefinition
                                    {
                                        AttributeName = "Id",
                                        AttributeType = ScalarAttributeType.N
                                    },
                                    new AttributeDefinition
                                    {
                                        AttributeName = "GsiHash",
                                        AttributeType = ScalarAttributeType.S
                                    },
                                    new AttributeDefinition
                                    {
                                        AttributeName = "GsiHash2",
                                        AttributeType = ScalarAttributeType.S
                                    },
                                    new AttributeDefinition
                                    {
                                        AttributeName = "GsiRange",
                                        AttributeType = ScalarAttributeType.S
                                    },
                                    new AttributeDefinition
                                    {
                                        AttributeName = "GsiRange2",
                                        AttributeType = ScalarAttributeType.S
                                    }
                                },
                                GlobalSecondaryIndexes = new System.Collections.Generic.List<GlobalSecondaryIndexDescription>
                                {
                                    new GlobalSecondaryIndexDescription
                                    {
                                        IndexName = "GSI1",
                                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                                        {
                                            new KeySchemaElement
                                            {
                                                AttributeName = "GsiHash",
                                                KeyType = KeyType.HASH
                                            },
                                            new KeySchemaElement
                                            {
                                                AttributeName = "GsiHash2",
                                                KeyType = KeyType.HASH
                                            },
                                            new KeySchemaElement
                                            {
                                                AttributeName = "GsiRange",
                                                KeyType = KeyType.RANGE
                                            },
                                            new KeySchemaElement
                                            {
                                                AttributeName = "GsiRange2",
                                                KeyType = KeyType.RANGE
                                            }
                                        },
                                        Projection = new Projection { ProjectionType = ProjectionType.ALL },
                                        IndexStatus = IndexStatus.ACTIVE
                                    }
                                }
                            }
                        };
                    }
                    // Default for TestEntity
                    return new DescribeTableResponse
                    {
                        Table = new TableDescription
                        {
                            TableName = "TestEntity",
                            KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                            {
                                new KeySchemaElement
                                {
                                    AttributeName = "Id",
                                    KeyType = KeyType.HASH
                                },
                                new KeySchemaElement
                                {
                                    AttributeName = "Name",
                                    KeyType = KeyType.RANGE
                                }
                            },
                            AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                            {
                                new AttributeDefinition
                                {
                                    AttributeName = "Id",
                                    AttributeType = ScalarAttributeType.N
                                },
                                new AttributeDefinition
                                {
                                    AttributeName = "Name",
                                    AttributeType = ScalarAttributeType.S
                                }
                            }
                        }
                    };
                });
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement
                            {
                                AttributeName = "Id",
                                KeyType = KeyType.HASH
                            }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition
                            {
                                AttributeName = "Id",
                                AttributeType = ScalarAttributeType.N
                            }
                        }
                    }
                });

            context = new DynamoDBContext(mockClient.Object, new DynamoDBContextConfig());
        }


        [TestMethod]
        public void ConvertScan_WithFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 = :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);

            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual(1, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertScan_WithNameFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Name == "foo";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 = :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Name", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual("foo", actualFilterExpression.ExpressionAttributeValues[":C0"].AsString());
        }

        [TestMethod]
        public void ConvertScan_WithGreaterThanFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Id > 10;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("#C0 > :C0", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeNames.ContainsKey("#C0"));
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualFilterExpression.ExpressionAttributeValues.ContainsKey(":C0"));
            Assert.AreEqual(10, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertScan_WithAndFilterExpression_ReturnsMappedFilterExpression()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Id == 1 && e.Name == "foo";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var result = context.ConvertScan<TestEntity>(filterExpr, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search.FilterExpression);
            var actualFilterExpression = result.Search.FilterExpression;
            Assert.AreEqual("(#C0 = :C0) AND (#C1 = :C1)", actualFilterExpression.ExpressionStatement);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", actualFilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.AreEqual("Name", actualFilterExpression.ExpressionAttributeNames["#C1"]);
            Assert.IsNotNull(actualFilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, actualFilterExpression.ExpressionAttributeValues[":C0"].AsInt());
            Assert.AreEqual("foo", actualFilterExpression.ExpressionAttributeValues[":C1"].AsString());
        }

        [TestMethod]
        public void ConvertQueryByValue_WithHashKeyOnly()
        {
            var result = context.ConvertQueryByValue<TestEntity>(1, null, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var actualResult = result.Search;
            Assert.IsNotNull(actualResult.Filter);
            Assert.AreEqual(1, actualResult.Filter.ToConditions().Count);
            Assert.IsNull(actualResult.FilterExpression);
            Assert.IsNotNull(actualResult.AttributesToGet);
            Assert.AreEqual(typeof(TestEntity).GetProperties().Length, actualResult.AttributesToGet.Count);
        }

        [TestMethod]
        public void ConvertQueryByValue_WithHashKeyAndExpressionFilter()
        {
            Expression<Func<TestEntity, bool>> expr = e => e.Name == "bar";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr
            };

            // Act
            var result = context.ConvertQueryByValue<TestEntity>(1, operationConfig, null);

            Assert.IsNotNull(result);

            var search = (dynamic)result;
            Assert.IsNotNull(search.Search);
            Assert.IsNotNull(search.Search.KeyExpression);
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionStatement.Contains("#hashKey0 = :hashKey0"));
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsNotNull(search.Search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.Search.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey0"));
            var keyValue = search.Search.KeyExpression.ExpressionAttributeValues[":hashKey0"];
            Assert.AreEqual(1, keyValue.AsInt());

            Assert.IsNotNull(search.Search.FilterExpression);
            Assert.AreEqual("#C0 = :C0", search.Search.FilterExpression.ExpressionStatement);
            Assert.AreEqual("Name", search.Search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.AreEqual("bar", search.Search.FilterExpression.ExpressionAttributeValues[":C0"].ToString());
        }
        [TestMethod]
        public void ConvertQueryConditional_WithHashKeyOnly_ReturnsValidSearch()
        {
            // Arrange
            var queryConditional = QueryConditional.HashKeyEqualTo("Id", 1);

            // Act
            var result = context.ConvertQueryConditional<ContextInternalTests.TestEntity>(queryConditional, null);

            // Assert
            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);

            var actualSearch = result.Search;
            Assert.IsNotNull(actualSearch.Filter);
            Assert.AreEqual(0, actualSearch.Filter.ToConditions().Count);
            Assert.IsNotNull(actualSearch.FilterExpression);
            Assert.IsFalse(actualSearch.FilterExpression.IsSet);
            Assert.IsNotNull(actualSearch.AttributesToGet);
            Assert.AreEqual(typeof(TestEntity).GetProperties().Length, actualSearch.AttributesToGet.Count);

            // Assert KeyExpression
            Assert.IsNotNull(actualSearch.KeyExpression);
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionStatement);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionStatement.Contains("#hashKey0 = :hashKey0"));
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey0"));
            var actualKeyValue = actualSearch.KeyExpression.ExpressionAttributeValues[":hashKey0"];
            Assert.AreEqual(1, actualKeyValue.AsInt());
        }

        [TestMethod]
        public void ConvertQueryConditional_WithHashKeyAndRangeKey_ReturnsValidSearch()
        {
            // Arrange
            var queryConditional = QueryConditional.HashKeyEqualTo("Id", 1)
                .AndRangeKeyEqualTo("Name", "test");

            // Act
            var result = context.ConvertQueryConditional<ContextInternalTests.TestEntity>(queryConditional, null);

            // Assert
            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);

            var actualSearch = result.Search;
            Assert.IsNotNull(actualSearch.Filter);
            Assert.AreEqual(0, actualSearch.Filter.ToConditions().Count);
            Assert.IsNotNull(actualSearch.FilterExpression);
            Assert.IsFalse(actualSearch.FilterExpression.IsSet);
            Assert.IsNotNull(actualSearch.AttributesToGet);
            Assert.AreEqual(typeof(TestEntity).GetProperties().Length, actualSearch.AttributesToGet.Count);

            // Assert KeyExpression for both hash and range key
            Assert.IsNotNull(actualSearch.KeyExpression);
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionStatement);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionStatement.Equals("#hashKey0 = :hashKey0 AND #rangeKey0 = :rangeKey0"));
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeNames.ContainsKey("#rangeKey0"));
            Assert.AreEqual("Id", actualSearch.KeyExpression.ExpressionAttributeNames["#hashKey0"]);
            Assert.AreEqual("Name", actualSearch.KeyExpression.ExpressionAttributeNames["#rangeKey0"]);
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey0"));
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKey0"));
            var actualHashKeyValue = actualSearch.KeyExpression.ExpressionAttributeValues[":hashKey0"];
            var actualRangeKeyValue = actualSearch.KeyExpression.ExpressionAttributeValues[":rangeKey0"];
            Assert.AreEqual(1, actualHashKeyValue.AsInt());
            Assert.AreEqual("test", actualRangeKeyValue.AsString());
        }

        [TestMethod]
        public void ConvertQueryConditional_WithGSIIndexNameAndOrder_ReturnsValidSearch()
        {
            // Arrange
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2");
            var operationConfig = new DynamoDBOperationConfig
            {
                IndexName = "GSI1"
            };

            // Act
            var result = context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);

            // Assert
            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var actualSearch = result.Search;
            Assert.IsNotNull(actualSearch.KeyExpression);
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionStatement);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionStatement.Contains("#hashKey0 = :hashKey0"));
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionStatement.Contains("AND #hashKey1 = :hashKey1"));
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey1"));
            Assert.AreEqual("GsiHash", actualSearch.KeyExpression.ExpressionAttributeNames["#hashKey0"]);
            Assert.AreEqual("GsiHash2", actualSearch.KeyExpression.ExpressionAttributeNames["#hashKey1"]);
            Assert.IsNotNull(actualSearch.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey0"));
            Assert.IsTrue(actualSearch.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey1"));
            Assert.AreEqual("hashValue1", actualSearch.KeyExpression.ExpressionAttributeValues[":hashKey0"].AsString());
            Assert.AreEqual("hashValue2", actualSearch.KeyExpression.ExpressionAttributeValues[":hashKey1"].AsString());
            Assert.AreEqual(SelectValues.AllProjectedAttributes, actualSearch.Select);
        }

        [TestMethod]
        public void ConvertQueryByValue_WithExpressionAndQueryFilter_ThrowsInvalidOperationException()
        {
            // Arrange: provide both an expression filter and a QueryFilter which should be incompatible
            Expression<Func<ContextInternalTests.TestEntity, bool>> expr = e => e.Name == "foo";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);

            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr,
                QueryFilter = new List<ScanCondition>
                {
                    new ScanCondition("Name", ScanOperator.Equal, "bar")
                }
            };

            // Act & Assert
            var ex = Assert.ThrowsException<InvalidOperationException>(() =>
                context.ConvertQueryByValue<ContextInternalTests.TestEntity>(1, QueryOperator.Equal, new object[] { "test" }, operationConfig));

            Assert.IsTrue(ex.Message.Contains("Cannot specify both QueryFilter and ExpressionFilter in the same operation configuration. Please use one or the other."), "Unexpected exception message: " + ex.Message);
        }

        [TestMethod]
        [ExpectedException(typeof(ArgumentNullException))]
        public void ConvertQueryConditional_WithNullQueryConditional_ThrowsArgumentNullException()
        {
            // Act
            context.ConvertQueryConditional<ContextInternalTests.TestEntity>(null, null);
        }

        [TestMethod]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ConvertQueryConditional_WithNullHashKeys_ThrowsInvalidOperationException()
        {
            // Arrange
            var queryConditional = QueryConditional.HashKeysEqual(null);

            // Act
            context.ConvertQueryConditional<ContextInternalTests.TestEntity>(queryConditional, null);
        }

        [TestMethod]
        public void ConvertQueryConditional_WithQueryFilter_ReturnsValidSearch()
        {
            // Arrange
            var queryFilter = new System.Collections.Generic.List<ScanCondition>
            {
                new ScanCondition("Name", ScanOperator.Equal, "foo")
            };
            var operationConfig = new DynamoDBOperationConfig
            {
                QueryFilter = queryFilter
            };
            var queryConditional = QueryConditional.HashKeyEqualTo("Id", 1);

            // Act
            var result = context.ConvertQueryConditional<ContextInternalTests.TestEntity>(queryConditional, operationConfig);

            // Assert
            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var actualSearch = result.Search;
            Assert.IsNotNull(actualSearch.Filter);
            var conditions = actualSearch.Filter.ToConditions();
            Assert.AreEqual(2, conditions.Count);
            Assert.IsTrue(conditions.ContainsKey("Name"));
            var condition = conditions["Name"];
            Assert.AreEqual(ComparisonOperator.EQ, condition.ComparisonOperator);
            Assert.AreEqual(1, condition.AttributeValueList.Count);
            Assert.AreEqual("foo", condition.AttributeValueList[0].S);
            Assert.IsTrue(conditions.ContainsKey("Id"));
            var keyCondition = conditions["Id"];
            Assert.AreEqual(ComparisonOperator.EQ, keyCondition.ComparisonOperator);
            Assert.AreEqual(1, keyCondition.AttributeValueList.Count);
            Assert.AreEqual("1", keyCondition.AttributeValueList[0].N);
            Assert.IsNull(actualSearch.FilterExpression);
            Assert.IsNotNull(actualSearch.AttributesToGet);
            Assert.AreEqual(typeof(TestEntity).GetProperties().Length, actualSearch.AttributesToGet.Count);
            Assert.IsNull(actualSearch.KeyExpression);
        }

        [TestMethod]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ConvertQueryByValues_WithRangeKeyPropertiesNotInModel_ThrowsInvalidOperationException()
        {
            // Arrange
            var hashKeys = 1;
            var operationConfig = new DynamoDBOperationConfig()
            {
                QueryFilter = new List<ScanCondition>
                {
                    new ScanCondition("ExtraRange", ScanOperator.Equal, "extra"),
                    new ScanCondition("Name", ScanOperator.Equal, "test")
                }
            };
            try
            {
                // Act
                context.ConvertQueryByValue<ContextInternalTests.TestEntity>(hashKeys, operationConfig, null);
            }
            catch (InvalidOperationException ex)
            {
                Assert.IsTrue(ex.Message.Contains("Unable to find storage information for property [ExtraRange]"));
                throw;
            }
        }

        [TestMethod]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ConvertQueryByValues_WithMoreThanOneRangeRangeKeyCondition_ThrowsInvalidOperationException()
        {
            // Arrange
            var hashKeys = new Dictionary<string, object> { { "GsiHash", "GsiHash" } ,
            { "GsiHash2", "GsiHash2" }};
            var operationConfig = new DynamoDBOperationConfig()
            {
                IndexName = "GSI1"
            };
            try
            {
                // Act
                context.ConvertQueryByValue<ContextInternalTests.TestGSIEntity>("GsiHash", operationConfig, null);
            }
            catch (InvalidOperationException ex)
            {
                Assert.IsTrue(ex.Message.Contains("The number of hash key properties provided (1) does not match the number of hash key properties defined (2)." +
                    " Index GSI1 has multiple hash keys. For multiple hash keys, use QueryConditional.KeyEqual() with a dictionary of key-value pairs."));
                throw;
            }
        }

        [TestMethod]
        public void ConvertFromQuery_WithQueryOperationConfig_ReturnsValidContextSearch()
        {
            // Arrange
            var queryConfig = new QueryOperationConfig
            {
                IndexName = "GSI1",
                Select = SelectValues.AllProjectedAttributes,
                Limit = 10,
                ConsistentRead = true
            };

            // Act
            var result = context.ConvertFromQuery<ContextInternalTests.TestEntity>(queryConfig, null);

            // Assert
            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            Assert.IsNotNull(result.FlatConfig);
            Assert.AreEqual("GSI1", result.Search.IndexName);
            Assert.AreEqual(SelectValues.AllProjectedAttributes, result.Search.Select);
            Assert.AreEqual(10, result.Search.Limit);
            Assert.IsTrue(result.Search.IsConsistentRead);
        }

        [TestMethod]
        public void ConvertFromQuery_WithQueryDocumentOperationRequest_ReturnsValidContextSearch()
        {
            // Arrange
            var request = new QueryDocumentOperationRequest
            {
                IndexName = "GSI1",
                Limit = 5,
                CollectResults = true,
                ConsistentRead = true
            };

            // Act
            var result = context.ConvertFromQuery<ContextInternalTests.TestEntity>(request, null);

            // Assert
            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            Assert.IsNotNull(result.FlatConfig);
            Assert.AreEqual("GSI1", result.Search.IndexName);
            Assert.AreEqual(5, result.Search.Limit);
            Assert.IsTrue(result.Search.CollectResults);
            Assert.IsTrue(result.Search.IsConsistentRead);
        }

        [TestMethod]
        public void ConvertQueryByValue_WithRangeEqualCondition_UsesQueryFilterNotKeyExpression()
        {
            var result = context.ConvertQueryByValue<ContextInternalTests.TestEntity>(1, QueryOperator.Equal, new object[] { "test" }, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);

            var search = result.Search;

            Assert.IsNotNull(search.Filter, "Expected Query.Filter to be set for ConvertQueryByValue with range condition.");
            var conditions = search.Filter.ToConditions();

            Assert.IsTrue(conditions.ContainsKey("Id"));
            var idCondition = conditions["Id"];
            Assert.AreEqual(ComparisonOperator.EQ, idCondition.ComparisonOperator);
            Assert.AreEqual(1, idCondition.AttributeValueList.Count);
            Assert.AreEqual("1", idCondition.AttributeValueList[0].N);

            Assert.IsTrue(conditions.ContainsKey("Name"));
            var nameCondition = conditions["Name"];
            Assert.AreEqual(ComparisonOperator.EQ, nameCondition.ComparisonOperator);
            Assert.AreEqual(1, nameCondition.AttributeValueList.Count);
            Assert.AreEqual("test", nameCondition.AttributeValueList[0].S);

            Assert.IsNull(search.KeyExpression, "Expected KeyExpression to be null when QueryFilter is used.");
        }

        [TestMethod]
        public void ConvertQueryByValue_WithBetweenOperator_UsesQueryFilterNotKeyExpression()
        {
            var result = context.ConvertQueryByValue<ContextInternalTests.TestEntity>(1, QueryOperator.Between, new object[] { "a", "z" }, null);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);

            var search = result.Search;

            Assert.IsNotNull(search.Filter, "Expected Query.Filter to be set for ConvertQueryByValue with BETWEEN range condition.");
            var conditions = search.Filter.ToConditions();

            Assert.IsTrue(conditions.ContainsKey("Id"));
            var idCondition = conditions["Id"];
            Assert.AreEqual(ComparisonOperator.EQ, idCondition.ComparisonOperator);
            Assert.AreEqual(1, idCondition.AttributeValueList.Count);
            Assert.AreEqual("1", idCondition.AttributeValueList[0].N);

            Assert.IsTrue(conditions.ContainsKey("Name"));
            var nameCondition = conditions["Name"];
            Assert.AreEqual(ComparisonOperator.BETWEEN, nameCondition.ComparisonOperator);
            Assert.AreEqual(2, nameCondition.AttributeValueList.Count);
            Assert.AreEqual("a", nameCondition.AttributeValueList[0].S);
            Assert.AreEqual("z", nameCondition.AttributeValueList[1].S);

            Assert.IsNull(search.KeyExpression, "Expected KeyExpression to be null when QueryFilter is used.");
        }

        [TestMethod]
        public void ConvertQueryByValue_WithRangeEqualCondition_AndExpressionFilter_BuildsKeyAndFilterExpressions()
        {
            Expression<Func<ContextInternalTests.TestEntity, bool>> expr = e => e.Name == "bar";
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);
            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr
            };

            var result = context.ConvertQueryByValue<ContextInternalTests.TestEntity>(1, QueryOperator.Equal, new object[] { "test" }, operationConfig);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var search = result.Search;

            Assert.IsNotNull(search.KeyExpression);
            Assert.IsNotNull(search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains("#hashKey0 = :hashKey0"));
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains("#rangeKey0 = :rangeKey0") ||
                          search.KeyExpression.ExpressionStatement.Contains("AND #rangeKey0 = :rangeKey0"));

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":hashKey0"));
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKey0"));
            Assert.AreEqual(1, search.KeyExpression.ExpressionAttributeValues[":hashKey0"].AsInt());
            Assert.AreEqual("test", search.KeyExpression.ExpressionAttributeValues[":rangeKey0"].AsString());

            Assert.IsNotNull(search.FilterExpression);
            Assert.AreEqual("#C0 = :C0", search.FilterExpression.ExpressionStatement);
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Name", search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeValues);
            Assert.AreEqual("bar", search.FilterExpression.ExpressionAttributeValues[":C0"].ToString());
        }

        [TestMethod]
        public void ConvertQueryByValue_WithBetweenOperator_AndExpressionFilter_BuildsKeyAndFilterExpressions()
        {
            Expression<Func<ContextInternalTests.TestEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);
            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr
            };

            var result = context.ConvertQueryByValue<ContextInternalTests.TestEntity>(1, QueryOperator.Between, new object[] { "a", "z" }, operationConfig);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var search = result.Search;

            Assert.IsNotNull(search.KeyExpression);
            Assert.IsNotNull(search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains(":rangeKeyL0"));
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains(":rangeKeyH0"));

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKeyL0"));
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKeyH0"));
            Assert.AreEqual("a", search.KeyExpression.ExpressionAttributeValues[":rangeKeyL0"].AsString());
            Assert.AreEqual("z", search.KeyExpression.ExpressionAttributeValues[":rangeKeyH0"].AsString());

            Assert.IsNotNull(search.FilterExpression);
            Assert.IsTrue(search.FilterExpression.ExpressionStatement.Contains("#C0 = :C0"));
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, search.FilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertQueryConditional_WithBetweenRangeCondition_AndExpressionFilter_BuildsKeyAndFilterExpressions_ForGSI()
        {
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2")
                .AndRangeKeyBetween("GsiRange", "a", "z");

            Expression<Func<ContextInternalTests.TestGSIEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);
            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr,
                IndexName = "GSI1"
            };

            var result = context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var search = result.Search;

            Assert.IsNotNull(search.KeyExpression);
            Assert.IsNotNull(search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains(":rangeKeyL0"));
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains(":rangeKeyH0"));

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey1"));
            Assert.AreEqual("GsiHash", search.KeyExpression.ExpressionAttributeNames["#hashKey0"]);
            Assert.AreEqual("GsiHash2", search.KeyExpression.ExpressionAttributeNames["#hashKey1"]);

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKeyL0"));
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKeyH0"));
            Assert.AreEqual("a", search.KeyExpression.ExpressionAttributeValues[":rangeKeyL0"].AsString());
            Assert.AreEqual("z", search.KeyExpression.ExpressionAttributeValues[":rangeKeyH0"].AsString());

            Assert.IsNotNull(search.FilterExpression);
            Assert.IsTrue(search.FilterExpression.ExpressionStatement.Contains("#C0 = :C0"));
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, search.FilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertQueryConditional_WithLessThanOrEqualRangeCondition_AndExpressionFilter_BuildsKeyAndFilterExpressions_ForGSI()
        {
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2")
                .AndRangeKeyLessThanOrEqual("GsiRange", "m");

            Expression<Func<ContextInternalTests.TestGSIEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);
            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr,
                IndexName = "GSI1"
            };

            var result = context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var search = result.Search;

            Assert.IsNotNull(search.KeyExpression);
            Assert.IsNotNull(search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains(":rangeKey0"));

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey1"));
            Assert.AreEqual("GsiHash", search.KeyExpression.ExpressionAttributeNames["#hashKey0"]);
            Assert.AreEqual("GsiHash2", search.KeyExpression.ExpressionAttributeNames["#hashKey1"]);

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKey0"));
            Assert.AreEqual("m", search.KeyExpression.ExpressionAttributeValues[":rangeKey0"].AsString());

            Assert.IsNotNull(search.FilterExpression);
            Assert.IsTrue(search.FilterExpression.ExpressionStatement.Contains("#C0 = :C0"));
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, search.FilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertQueryConditional_WithLessThanRangeCondition_AndExpressionFilter_BuildsKeyAndFilterExpressions_ForGSI()
        {
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2")
                .AndRangeKeyLessThan("GsiRange", "m");

            Expression<Func<ContextInternalTests.TestGSIEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);
            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr,
                IndexName = "GSI1"
            };

            var result = context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var search = result.Search;

            Assert.IsNotNull(search.KeyExpression);
            Assert.IsNotNull(search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains(":rangeKey0"));

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey1"));
            Assert.AreEqual("GsiHash", search.KeyExpression.ExpressionAttributeNames["#hashKey0"]);
            Assert.AreEqual("GsiHash2", search.KeyExpression.ExpressionAttributeNames["#hashKey1"]);

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKey0"));
            Assert.AreEqual("m", search.KeyExpression.ExpressionAttributeValues[":rangeKey0"].AsString());

            Assert.IsNotNull(search.FilterExpression);
            Assert.IsTrue(search.FilterExpression.ExpressionStatement.Contains("#C0 = :C0"));
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, search.FilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        public void ConvertQueryConditional_WithGreaterThanOrEqualRangeCondition_AndExpressionFilter_BuildsKeyAndFilterExpressions_ForGSI()
        {
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2")
                .AndRangeKeyGreaterThanOrEqual("GsiRange", "m");

            Expression<Func<ContextInternalTests.TestGSIEntity, bool>> expr = e => e.Id == 1;
            var filterExpr = new ContextExpression();
            filterExpr.SetFilter(expr);
            var operationConfig = new DynamoDBOperationConfig
            {
                Expression = filterExpr,
                IndexName = "GSI1"
            };

            var result = context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);

            Assert.IsNotNull(result);
            Assert.IsNotNull(result.Search);
            var search = result.Search;

            Assert.IsNotNull(search.KeyExpression);
            Assert.IsNotNull(search.KeyExpression.ExpressionStatement);
            Assert.IsTrue(search.KeyExpression.ExpressionStatement.Contains(":rangeKey0"));

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeNames);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey0"));
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeNames.ContainsKey("#hashKey1"));
            Assert.AreEqual("GsiHash", search.KeyExpression.ExpressionAttributeNames["#hashKey0"]);
            Assert.AreEqual("GsiHash2", search.KeyExpression.ExpressionAttributeNames["#hashKey1"]);

            Assert.IsNotNull(search.KeyExpression.ExpressionAttributeValues);
            Assert.IsTrue(search.KeyExpression.ExpressionAttributeValues.ContainsKey(":rangeKey0"));
            Assert.AreEqual("m", search.KeyExpression.ExpressionAttributeValues[":rangeKey0"].AsString());

            Assert.IsNotNull(search.FilterExpression);
            Assert.IsTrue(search.FilterExpression.ExpressionStatement.Contains("#C0 = :C0"));
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeNames);
            Assert.AreEqual("Id", search.FilterExpression.ExpressionAttributeNames["#C0"]);
            Assert.IsNotNull(search.FilterExpression.ExpressionAttributeValues);
            Assert.AreEqual(1, search.FilterExpression.ExpressionAttributeValues[":C0"].AsInt());
        }

        [TestMethod]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ConvertQueryConditional_WithTooManyRangeKeyConditions_ThrowsInvalidOperationException()
        {
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2")
                .AndRangeKeyEqualTo("GsiRange", "a")
                .AndRangeKeyEqualTo("GsiRange2", "b")
                .AndRangeKeyEqualTo("ExtraRange", "c");

            var operationConfig = new DynamoDBOperationConfig
            {
                IndexName = "GSI1"
            };

            try
            {
                context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);
            }
            catch (InvalidOperationException ex)
            {
                Assert.IsTrue(ex.Message.Contains("The number of range key properties provided (3) exceeds the number of range key properties defined (2)."),
                    "Unexpected exception message: " + ex.Message);
                throw;
            }
        }

        [TestMethod]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ConvertQueryConditional_WithMissingHashKeyProperty_ThrowsInvalidOperationException()
        {
            // Arrange: provide a hash-keys dictionary that doesn't contain the expected attribute name "Id"
            var hashKeys = new Dictionary<string, object>
            {
                { "MissingHashAttribute", 1 }
            };
            var queryConditional = QueryConditional.HashKeysEqual(hashKeys);

            try
            {
                // Act
                context.ConvertQueryConditional<ContextInternalTests.TestEntity>(queryConditional, null);
            }
            catch (InvalidOperationException ex)
            {
                // Assert: ensure the exception mentions the missing hash key property name (Id)
                Assert.IsTrue(ex.Message.Contains("The hash key property 'Id' was not found in the provided hash keys."),
                    "Unexpected exception message: " + ex.Message);
                throw;
            }
        }

        [TestMethod]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ConvertQueryConditional_WithNonContiguousRangeKeyConditions_ThrowsInvalidOperationException()
        {
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2")
                .AndRangeKeyEqualTo("GsiRange2", "b");

            var operationConfig = new DynamoDBOperationConfig
            {
                IndexName = "GSI1"
            };

            try
            {
                // Act
                context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);
            }
            catch (InvalidOperationException ex)
            {
                Assert.IsTrue(ex.Message.Contains("contiguous, left-to-right prefix"), "Unexpected exception message: " + ex.Message);
                Assert.IsTrue(ex.Message.Contains("Missing condition for attribute 'GsiRange'"), "Unexpected exception message: " + ex.Message);
                throw;
            }
        }

        [TestMethod]
        [ExpectedException(typeof(InvalidOperationException))]
        public void ConvertQueryConditional_WithNonEqualityOperatorNotRightMost_ThrowsInvalidOperationException()
        {
            var queryConditional = QueryConditional.HashKeyEqualTo("GsiHash", "hashValue1")
                .AndHashKeyEqualTo("GsiHash2", "hashValue2")
                .AndRangeKeyGreaterThan("GsiRange", "m")    
                .AndRangeKeyEqualTo("GsiRange2", "z");

            var operationConfig = new DynamoDBOperationConfig
            {
                IndexName = "GSI1"
            };

            try
            {
                context.ConvertQueryConditional<ContextInternalTests.TestGSIEntity>(queryConditional, operationConfig);
            }
            catch (InvalidOperationException ex)
            {
                Assert.IsTrue(ex.Message.Contains("Only the right-most range key condition may use a non-equality operator"), "Unexpected exception message: " + ex.Message);
                Assert.IsTrue(ex.Message.Contains("Operator 'GreaterThan'") && ex.Message.Contains("GsiRange"), "Unexpected exception message: " + ex.Message);
                throw;
            }
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithNoIfNotExistsProperties_ReturnsEmptyList()
        {
            var itemStorage = new ItemStorage(new
                ItemStorageConfig(typeof(TestEntity)))
            {
            };
            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(0, result.Count);
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithIfNotExistsProperties_ReturnsAttributeNames()
        {
            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntityWithUpdateBehavior>(flatConfig);
            var itemStorage = new ItemStorage(config)
            {
                Document = new Document()
            };
            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(1, result.Count);
            Assert.AreEqual("Prop1", result.FirstOrDefault());
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithFlattenedIfNotExistsProperties_ReturnsAllAttributeNames()
        {
            // Fix: use flattened entity config instead of TestEntityWithUpdateBehavior
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntityWithFlattenedUpdateBehavior>(flatConfig);
            var itemStorage = new ItemStorage(config)
            {
                Document = new Document()
            };
            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(1, result.Count);
            Assert.IsTrue(result.Contains("Prop1"));
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithDeepFlattenedHierarchy_ReturnsAllNestedAttributeNames()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithDeepFlatten")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithDeepFlatten",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<DeepFlattenEntity>(flatConfig);
            var itemStorage = new ItemStorage(config) { Document = new Document() };

            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(3, result.Count);
            Assert.IsTrue(result.Contains("PropA"));
            Assert.IsTrue(result.Contains("PropB"));
            Assert.IsTrue(result.Contains("PropC"));
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithDeepFlattenedHierarchyPartial_ReturnsOnlyMatchingAttributes()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithDeepFlattenPartial")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithDeepFlattenPartial",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<DeepFlattenEntityPartial>(flatConfig);
            var itemStorage = new ItemStorage(config) { Document = new Document() };

            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(1, result.Count);
            Assert.IsTrue(result.Contains("PropA"));
        }

        [TestMethod]
        public void GetUpdateIfNotExistsAttributeNames_WithSiblingFlattenedProperties_ReturnsDistinctAttributeNames()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithSiblingFlatten")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithSiblingFlatten",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<SiblingFlattenEntity>(flatConfig);
            var itemStorage = new ItemStorage(config) { Document = new Document() };

            var result = DynamoDBContext.GetUpdateIfNotExistsAttributeNames(itemStorage);

            Assert.AreEqual(2, result.Count);
            Assert.IsTrue(result.Contains("PropX"));
            Assert.IsTrue(result.Contains("PropY"));
        }
        [TestMethod]
        public void BuildCounterConditionExpression_NoCounters_ReturnsNull()
        {
            var itemStorage = new ItemStorage(new ItemStorageConfig(typeof(TestEntity)));
            // Ensure no property marked as counter
            foreach (var p in itemStorage.Config.BaseTypeStorageConfig.Properties)
                p.IsCounter = false;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNull(result);
        }

        [TestMethod]
        public void BuildCounterConditionExpression_MultipleCounters_ReturnsExpressionWithAllCounters()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntity>(flatConfig);
            var itemStorage = new ItemStorage(config);

            var props = itemStorage.Config.BaseTypeStorageConfig.Properties;

            var first = props.First(p => p.PropertyName == nameof(TestEntity.Id));
            var second = props.First(p => p.PropertyName == nameof(TestEntity.NullableValue));

            first.IsCounter = true;
            first.CounterStartValue = 5;
            first.CounterDelta = 2;

            second.IsCounter = true;
            second.CounterStartValue = 100;
            second.CounterDelta = 10;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNotNull(result);
            Assert.IsFalse(string.IsNullOrEmpty(result.ExpressionStatement));
            // Expression should contain both attribute names
            Assert.IsTrue(result.ExpressionStatement.Contains(first.AttributeName));
            Assert.IsTrue(result.ExpressionStatement.Contains(second.AttributeName));
            // Delta keys
            var firstDeltaKey = ":" + first.AttributeName + "Delta";
            var firstStartKey = ":" + first.AttributeName + "Start";
            var secondDeltaKey = ":" + second.AttributeName + "Delta";
            var secondStartKey = ":" + second.AttributeName + "Start";

            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(firstDeltaKey));
            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(firstStartKey));
            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(secondDeltaKey));
            Assert.IsTrue(result.ExpressionAttributeValues.ContainsKey(secondStartKey));

            Assert.AreEqual(first.CounterDelta, result.ExpressionAttributeValues[firstDeltaKey].AsInt());
            Assert.AreEqual(first.CounterStartValue - first.CounterDelta, result.ExpressionAttributeValues[firstStartKey].AsInt());
            Assert.AreEqual(second.CounterDelta, result.ExpressionAttributeValues[secondDeltaKey].AsInt());
            Assert.AreEqual(second.CounterStartValue - second.CounterDelta, result.ExpressionAttributeValues[secondStartKey].AsInt());
        }

        [TestMethod]
        public void BuildCounterConditionExpression_FlattenedSingleCounter_ReturnsExpression()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithUpdateBehavior")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithUpdateBehavior",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<TestEntityWithFlattenedUpdateBehavior>(flatConfig);
            var itemStorage = new ItemStorage(config);

            // Locate flattened parent property
            var flattenParent = itemStorage.Config.BaseTypeStorageConfig.Properties.First(p => p.ShouldFlattenChildProperties);
            var child = flattenParent.FlattenProperties.First(fp => fp.AttributeName == "Prop1");
            child.IsCounter = true;
            child.CounterStartValue = 10;
            child.CounterDelta = 3;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNotNull(result);
            Assert.IsTrue(result.ExpressionStatement.Contains("Prop1"));
            var deltaKey = ":Prop1Delta";
            var startKey = ":Prop1Start";
            Assert.AreEqual(child.CounterDelta, result.ExpressionAttributeValues[deltaKey].AsInt());
            Assert.AreEqual(child.CounterStartValue - child.CounterDelta, result.ExpressionAttributeValues[startKey].AsInt());
        }

        [TestMethod]
        public void BuildCounterConditionExpression_FlattenedSiblingCounters_ReturnsExpressionForAll()
        {
            mockClient.Setup(m => m.DescribeTable(It.Is<DescribeTableRequest>(r => r.TableName == "TestEntityWithSiblingFlatten")))
                .Returns(new DescribeTableResponse
                {
                    Table = new TableDescription
                    {
                        TableName = "TestEntityWithSiblingFlatten",
                        KeySchema = new System.Collections.Generic.List<KeySchemaElement>
                        {
                            new KeySchemaElement { AttributeName = "Id", KeyType = KeyType.HASH }
                        },
                        AttributeDefinitions = new System.Collections.Generic.List<AttributeDefinition>
                        {
                            new AttributeDefinition { AttributeName = "Id", AttributeType = ScalarAttributeType.N }
                        }
                    }
                });

            var flatConfig = new DynamoDBFlatConfig(new DynamoDBOperationConfig(), context.Config);
            var config = context.StorageConfigCache.GetConfig<SiblingFlattenEntity>(flatConfig);
            var itemStorage = new ItemStorage(config);

            var flattenParents = itemStorage.Config.BaseTypeStorageConfig.Properties.Where(p => p.ShouldFlattenChildProperties).ToList();
            Assert.AreEqual(2, flattenParents.Count, "Expected two flattened parent properties (A and B).");

            var propX = flattenParents.SelectMany(p => p.FlattenProperties).First(fp => fp.AttributeName == "PropX");
            var propY = flattenParents.SelectMany(p => p.FlattenProperties).First(fp => fp.AttributeName == "PropY");

            propX.IsCounter = true;
            propX.CounterStartValue = 50;
            propX.CounterDelta = 5;

            propY.IsCounter = true;
            propY.CounterStartValue = 200;
            propY.CounterDelta = 20;

            var result = DynamoDBContext.BuildCounterConditionExpression(itemStorage);

            Assert.IsNotNull(result);
            Assert.IsTrue(result.ExpressionStatement.Contains("PropX"));
            Assert.IsTrue(result.ExpressionStatement.Contains("PropY"));

            Assert.AreEqual(propX.CounterDelta, result.ExpressionAttributeValues[":PropXDelta"].AsInt());
            Assert.AreEqual(propX.CounterStartValue - propX.CounterDelta, result.ExpressionAttributeValues[":PropXStart"].AsInt());
            Assert.AreEqual(propY.CounterDelta, result.ExpressionAttributeValues[":PropYDelta"].AsInt());
            Assert.AreEqual(propY.CounterStartValue - propY.CounterDelta, result.ExpressionAttributeValues[":PropYStart"].AsInt());
        }
    }
}