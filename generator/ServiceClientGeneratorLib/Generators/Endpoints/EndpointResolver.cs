// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 17.0.0.0
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------
namespace ServiceClientGenerator.Generators.Endpoints
{
    using System.Linq;
    using System.Text;
    using System.Collections.Generic;
    using ServiceClientGenerator.Endpoints;
    using System;
    
    /// <summary>
    /// Class to produce the template output
    /// </summary>
    
    #line 1 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "17.0.0.0")]
    public partial class EndpointResolver : BaseGenerator
    {
#line hidden
        /// <summary>
        /// Create the template output
        /// </summary>
        public override string TransformText()
        {
            
            #line 7 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"

    AddLicenseHeader();

            
            #line default
            #line hidden
            this.Write("\r\nusing System;\r\nusing System.Linq;\r\nusing System.Collections.Generic;\r\nusing Ama" +
                    "zon.");
            
            #line 14 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Config.ServiceNameRoot));
            
            #line default
            #line hidden
            this.Write(".Model;\r\nusing Amazon.Runtime;\r\nusing Amazon.Runtime.Internal;\r\nusing Amazon.Runt" +
                    "ime.Endpoints;\r\nusing Amazon.Util;\r\nusing ");
            
            #line 19 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Config.Namespace));
            
            #line default
            #line hidden
            this.Write(".Endpoints;\r\n\r\n#pragma warning disable 1591\r\n\r\nnamespace ");
            
            #line 23 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Config.Namespace));
            
            #line default
            #line hidden
            this.Write(".Internal\r\n{\r\n    /// <summary>\r\n    /// Amazon ");
            
            #line 26 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.Config.ClassName));
            
            #line default
            #line hidden
            this.Write(" endpoint resolver.\r\n    /// Custom PipelineHandler responsible for resolving end" +
                    "point and setting authentication parameters for ");
            
            #line 27 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.Config.ClassName));
            
            #line default
            #line hidden
            this.Write(" service requests.\r\n    /// Collects values for ");
            
            #line 28 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.Config.ClassName));
            
            #line default
            #line hidden
            this.Write("EndpointParameters and then tries to resolve endpoint by calling \r\n    /// Resolv" +
                    "eEndpoint method on GlobalEndpoints.Provider if present, otherwise uses ");
            
            #line 29 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.Config.ClassName));
            
            #line default
            #line hidden
            this.Write("EndpointProvider.\r\n    /// Responsible for setting authentication and http header" +
                    "s provided by resolved endpoint.\r\n    /// </summary>\r\n    public class Amazon");
            
            #line 32 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Config.ClassName));
            
            #line default
            #line hidden
            this.Write("EndpointResolver : BaseEndpointResolver\r\n    {\r\n        protected override void S" +
                    "erviceSpecificHandler(IExecutionContext executionContext, EndpointParameters par" +
                    "ameters)\r\n        {\r\n");
            
            #line 36 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
 if (Config.ServiceId == "S3") {
            
            #line default
            #line hidden
            this.Write(@"            // Special handling of SigV2 for S3
            if (parameters[""Bucket""] != null)
            {
                // SigV2 support, CanonicalResourcePrefix required for proper signing
                executionContext.RequestContext.Request.CanonicalResourcePrefix = ""/"" + parameters[""Bucket""];
            }
            // If the marshalled request has the SSE header and it is set to KMS, force SigV4 for this request.
            // Current operations that may set this header: CopyObject, CopyPart, InitiateMultipart, PutObject
            string sseHeaderValue;
            if (executionContext.RequestContext.Request.Headers.TryGetValue(HeaderKeys.XAmzServerSideEncryptionHeader, out sseHeaderValue) &&
                (string.Equals(sseHeaderValue, ServerSideEncryptionMethod.AWSKMS.Value, StringComparison.Ordinal) || string.Equals(sseHeaderValue, ServerSideEncryptionMethod.AWSKMSDSSE.Value, StringComparison.Ordinal)))
            {
                executionContext.RequestContext.Request.SignatureVersion = SignatureVersion.SigV4;
            }
");
            
            #line 51 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
 } 
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 53 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
 if (!this.dontInjectHostPrefixForServices.Contains(Config.ServiceId)) {
            
            #line default
            #line hidden
            this.Write("            InjectHostPrefix(executionContext.RequestContext);\r\n");
            
            #line 55 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
 } 
            
            #line default
            #line hidden
            this.Write("        }\r\n\r\n        protected override EndpointParameters MapEndpointsParameters" +
                    "(IRequestContext requestContext)\r\n        {\r\n            var config = (Amazon");
            
            #line 60 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Config.ClassName));
            
            #line default
            #line hidden
            this.Write("Config)requestContext.ClientConfig;\r\n            var result = new ");
            
            #line 61 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Config.ClassName));
            
            #line default
            #line hidden
            this.Write("EndpointParameters();\r\n");
            
            #line 62 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.AssignBuiltins()));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 63 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.AssignClientContext()));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 64 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
if (Config.EndpointsRuleSet.parameters.ContainsKey("Region")) {
            
            #line default
            #line hidden
            this.Write(@"            // The region needs to be determined from the ServiceURL if not set.
            var regionEndpoint = config.RegionEndpoint;
            if (regionEndpoint == null && !string.IsNullOrEmpty(config.ServiceURL))
            {
                // Use the specified signing region if it was provided alongside a custom ServiceURL
                if (!string.IsNullOrEmpty(config.AuthenticationRegion))
                {
                    result.Region = config.AuthenticationRegion;
                }
                else // try to extract a region from the custom ServiceURL
                {
                    var regionName = AWSSDKUtils.DetermineRegion(config.ServiceURL);
                    result.Region = RegionEndpoint.GetBySystemName(regionName).SystemName;
                }
            }

            // To support legacy endpoint overridding rules in the endpoints.json
            if (result.Region == ""us-east-1-regional"")
            {
                result.Region = ""us-east-1"";
            }

            // Use AlternateEndpoint region override if set
            if (requestContext.Request.AlternateEndpoint != null)
            {
                result.Region = requestContext.Request.AlternateEndpoint.SystemName;
            }

");
            
            #line 93 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
}
            
            #line default
            #line hidden
            
            #line 94 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"

            // GetACL and PutACL are deprecated in V4 and may be removed in the future

            
            #line default
            #line hidden
            
            #line 97 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
if (Config.ClassName == "S3") {
            
            #line default
            #line hidden
            this.Write(@"            // Special handling of GetPreSignedUrlRequest
            if (requestContext.Request.RequestName == ""GetPreSignedUrlRequest"")
            {
                var request = (GetPreSignedUrlRequest)requestContext.Request.OriginalRequest;
                result.Bucket = request.BucketName;
                return result;
            }
            // Special handling of CreatePresignedPostRequest
            if (requestContext.Request.RequestName == ""CreatePresignedPostRequest"")
            {
                var request = (CreatePresignedPostRequest)requestContext.Request.OriginalRequest;
                result.Bucket = request.BucketName;
                return result;
            }
            if (requestContext.RequestName == ""GetACLRequest"") {
                result.UseS3ExpressControlEndpoint = true;
                var request = (GetACLRequest)requestContext.OriginalRequest;
                result.Bucket = request.BucketName;
                return result;
            }
            if (requestContext.RequestName == ""PutACLRequest"") {
                result.UseS3ExpressControlEndpoint = true;
                var request = (PutACLRequest)requestContext.OriginalRequest;
                result.Bucket = request.BucketName;
                return result;
            }
");
            
            #line 124 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
}
            
            #line default
            #line hidden
            this.Write("\r\n            // Assign staticContextParams and contextParam per operation\r\n");
            
            #line 127 "C:\dev\repos\aws-sdk-net\generator\ServiceClientGeneratorLib\Generators\Endpoints\EndpointResolver.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(this.AssignOperationContext()));
            
            #line default
            #line hidden
            this.Write("\r\n            return result;\r\n        }\r\n    }\r\n}");
            return this.GenerationEnvironment.ToString();
        }
    }
    
    #line default
    #line hidden
}
